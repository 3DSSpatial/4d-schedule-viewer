<!DOCTYPE html>
<html>
  <head>
    <title>Zea 4D Schedule Viewer</title>
    <link
      rel="shortcut icon"
      type="image/png"
      href="./data/favicon-32x32.png"
    />
    <meta charset="UTF-8" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.9/tailwind.min.css"
    />
    <link rel="stylesheet" href="./src/styles.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@zeainc/zea-engine@3/dist/index.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zeainc/zea-engine@3/dist/plugins.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zeainc/zea-cad@3/dist/index.umd.js"></script>
    <script src="./src/zea-fps-display.js" type="module"></script>
    <script src="./src/scene-tree-view.js" type="module"></script>
    <script src="./src/schedule-view.js" type="module"></script>

    <script src="./src/third-party/xlsx.js"></script>
    <script src="./src/third-party/jszip.js"></script>
    <script src="./src/third-party/moment.min.js"></script>

  </head>
  <body class="overflow-hidden">
    <div class="layout grid h-screen">
      <header class="border flex justify-left items-center m-2 border-none">
        <img src="./data/logo-zea.svg" id="logo"></img>
      </header>
      <main>
        <div id="topPanel">
          <div class="splitter">
            <div id="leftPanel">
              <scene-tree-view
                id="tree"
                class="select-none"
              ></scene-tree-view>
            </div>
            <div class="separator" id="separatorV"></div>
            <div id="mainPanel">
              <div id="canvas-holder">
                <canvas id="canvas" style="position: absolute;"> </canvas>
              </div>
              <div class="xr-button hidden" id="xr-button"></div>
              <zea-fps-display class="fps-display" id="fps"></zea-fps-display>
              <progress class="progress-display" id="progress" value="0" max="100">
                0%
              </progress>
            </div>
          </div>
        </div>
        <div class="separator" id="separatorH"></div>
        <div id="bottomPanel">
          <schedule-view  id="schedule"></schedule-view>
        </div>
      </main>
    </div>
    <script type="module">
      import dragElement from './src/panels.js'
      const separatorV = document.getElementById("separatorV");
      const leftPanel = document.getElementById("leftPanel");
      const mainPanel = document.getElementById("mainPanel");
      dragElement(separatorV, leftPanel, mainPanel, "H");

      const separatorH = document.getElementById("separatorH");
      const topPanel = document.getElementById("topPanel");
      const bottomPanel = document.getElementById("bottomPanel");
      dragElement(separatorH, topPanel, bottomPanel, "V");
    </script>

    <script type="module">
      const {
        Color,
        Vec3,
        EulerAngles,
        Xfo,
        ObjAsset,
        Scene,
        GLRenderer,
        EnvMap,
        resourceLoader,
        GeomItem,
        MeshProxy,
        LinesProxy,
      } = zeaEngine;
      const { CADAsset, CADBody } = zeaCad;

      const urlParams = new URLSearchParams(window.location.search);
      const scene = new Scene();
      // scene.setupGrid(10.0, 10);

      const renderer = new GLRenderer(document.getElementById("canvas"), {
        debugGeomIds: false,
      });
      // renderer.outlineThickness = 0.75
      // renderer.outlineSensitivity = 5
      // renderer.solidAngleLimit = 0.0;
      renderer.setScene(scene);
      renderer
        .getViewport()
        .getCamera()
        .setPositionAndTarget(new Vec3(12, 12, 10), new Vec3(0, 0, 1.5));

      const envMap = new EnvMap();
      envMap.load("./data/StudioG.zenv");
      scene.setEnvMap(envMap);

      // renderer.on("resized", (event) => {
      //   console.log("resized:", event)
      // });

      //   renderer.on("redrawOccurred", () => {
      //   console.log("redrawOccurred")
      // });

      scene.getSettings().getParameter('BackgroundColor').setValue(new Color('#87CEEB'))
      // .getViewport().setBackgroundColor(new Color('#87CEEB'))
      renderer
      .getViewport()
      .getCamera()
      .setPositionAndTarget(new Vec3(-80, -40, 20), new Vec3(40, 80, 10))

      import init from "./src/init.js";
      const schedule = init(scene)

      // Setup TreeView Display
      const treeElement = document.getElementById("tree");
      treeElement.setTreeItem(scene.getRoot());

      // Setup Schedule view
      const scheduleViewer = document.getElementById("schedule");
      scheduleViewer.schedule = schedule

      // Setup FPS Display
      const fpsElement = document.getElementById("fps");
      fpsElement.renderer = renderer;


      const filterItem = (item) => item

      renderer.getViewport().on("pointerDown", (event) => {
        if (event.intersectionData) {
          const  geomItem = filterItem(event.intersectionData.geomItem);
          console.log(geomItem.getPath());
        }
      });

      resourceLoader.on("progressIncremented", (event) => {
        const pct = document.getElementById("progress");
        pct.value = event.percent;
        if (event.percent >= 100) {
          setTimeout(() => pct.classList.add("hidden"), 1000);
        }
      });

      renderer.getXRViewport().then((xrvp) => {
        fpsElement.style.bottom = "70px";

        const xrButton = document.getElementById("xr-button");
        xrButton.textContent = "Launch VR";
        xrButton.classList.remove("hidden");

        xrvp.on("presentingChanged", (event) => {
          const { state } = event;
          if (state) {
            xrButton.textContent = "Exit VR";
          } else {
            xrButton.textContent = "Launch VR";
          }
        });

        xrButton.addEventListener("click", function (event) {
          xrvp.togglePresenting();
        });

        document.addEventListener("keydown", (event) => {
          if (event.key == " ") {
            xrvp.togglePresenting();
          }
        });
      });

      if (urlParams.has("profile")) {
        renderer.startContinuousDrawing();
      }
    </script>
  </body>
</html>
